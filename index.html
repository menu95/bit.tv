<script>
  document.addEventListener("DOMContentLoaded", () => {
    const playerContainer = document.getElementById("player-container");
    const videoPlayer = document.getElementById("video-player");

    const videoJsPlayer = videojs(videoPlayer, {
      autoplay: true,
      controls: true,
      controlBar: {
        fadeIn: true,
        fadeOut: true,
      },
      fluid: true,
    });

    let currentPlayer = null;
    let isGoogleDriveVideoSelected = false;

    const channelList = document.getElementById("channel-list");
    const channelItems = channelList.querySelectorAll("li");
    const epg = document.getElementById("epg");
    const epgList = document.getElementById("epg-list");
    let currentIndex = 0;

    const googleDriveVideos = [
      { src: "https://drive.google.com/file/d/1app5Yc_gE8uo-9VDnfqR6slB0o0HCBzs/preview", duration: 7 * 3600 + 49 * 60 + 53 },
      { src: "https://drive.google.com/file/d/18-w4L94B7aEIHDYHMPFr-wz_euZkEqWe/preview", duration: 2 * 3600 + 50 * 56 },
      { src: "https://drive.google.com/file/d/1_CQNG7tw7V4Tw09ML20KP3Iqa-IFyOha/preview", duration: 4 * 3600 + 47 * 60 + 5 },
      { src: "https://drive.google.com/file/d/19lGmzpzCPRLfUpq4OzkyGE_pQTbdl5nA/preview", duration: 3 * 3600 + 33 * 60 + 32 },
      { src: "https://drive.google.com/file/d/1mTtAYUw9kBzJxc4IboYuS1xpr0NLzwG8/preview", duration: 4 * 3600 + 6 * 53 },
      { src: "https://drive.google.com/file/d/1JEkFZ3LSV8bQz0BBW4okPj_ELOD6JfJK/preview", duration: 1 * 3600 + 21 * 23 },
      { src: "https://drive.google.com/file/d/1vxJMpGv2ujgSheJJ4nWPeiEtuzJTOnVl/preview", duration: 3 * 3600 + 16 * 0 },
      { src: "https://drive.google.com/file/d/1bpY4bXxy4UNl3aKZbKiYNQbfPoPZ-1ip/preview", duration: 1 * 3600 + 39 * 53 },
      { src: "https://drive.google.com/file/d/1_Zz2ns8ZIefb4z5zA1-KZYuE24kb1xog/preview", duration: 1 * 3600 + 39 * 53 }
    ];

    const startTime = new Date("2024-05-28T11:10:00Z");

    const updateVisualSelection = () => {
      channelItems.forEach((item, index) => {
        if (index === currentIndex) {
          item.classList.add("selected");
          item.scrollIntoView({ behavior: "smooth", block: "nearest" });
        } else {
          item.classList.remove("selected");
        }
      });
    };

    const getCurrentVideo = () => {
      const now = new Date();
      const elapsedTime = Math.floor((now - startTime) / 1000);
      const totalDuration = googleDriveVideos.reduce((acc, video) => acc + video.duration, 0);
      const loopTime = elapsedTime % totalDuration;
      let currentTime = 0;

      for (let video of googleDriveVideos) {
        currentTime += video.duration;
        if (loopTime < currentTime) {
          const startOffset = loopTime - (currentTime - video.duration);
          return {
            src: video.src,
            startOffset,
            duration: video.duration - startOffset,
          };
        }
      }
    };

    const playGoogleDriveVideo = () => {
      const currentVideo = getCurrentVideo();
      playerContainer.innerHTML = `
            <iframe 
                id="current-video"
                src="${currentVideo.src}#t=${currentVideo.startOffset}" 
                width="100%" 
                height="100%" 
                allow="autoplay" 
                style="border:none;" 
                tabindex="0"></iframe>`;

      currentPlayer = document.getElementById("current-video");
      currentPlayer.focus();
    };

    const updateVideoSource = () => {
      const selectedItem = channelItems[currentIndex];
      const newSrc = selectedItem.getAttribute("data-src");
      const newType = selectedItem.getAttribute("data-type");

      stopCurrentPlayer();

      if (newType === "m3u8") {
        playerContainer.innerHTML =
          '<video id="video-player" class="video-js vjs-default-skin" controls autoplay></video>';
        currentPlayer = document.getElementById("video-player");
        const videoJsPlayer = videojs(currentPlayer, {
          autoplay: true,
          controls: true,
          controlBar: {
            fadeIn: true,
            fadeOut: true,
          },
          fluid: true,
        });
        videoJsPlayer.src({ type: "application/x-mpegURL", src: newSrc });
        videoJsPlayer.play();
        isGoogleDriveVideoSelected = false;
      } else if (newType === "iframe") {
        playGoogleDriveVideo();
        isGoogleDriveVideoSelected = true;
      }
    };

    const stopCurrentPlayer = () => {
      if (currentPlayer) {
        if (currentPlayer.tagName.toLowerCase() === "video") {
          const videoJsPlayer = videojs(currentPlayer);
          videoJsPlayer.dispose();
        } else if (currentPlayer.tagName.toLowerCase() === "iframe") {
          currentPlayer.remove();
        }
      }
    };

    const openChannelMenu = () => {
      if (channelList.classList.contains("open")) {
        updateVideoSource();
        channelList.classList.remove("open");
      } else if (
        isGoogleDriveVideoSelected &&
        document.activeElement === currentPlayer
      ) {
        currentPlayer.focus();
        document.activeElement.blur();
        currentPlayer.contentWindow.document.querySelector("video").play();
        isGoogleDriveVideoSelected = false;
      } else {
        channelList.classList.add("open");
      }
    };

    document.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === "Backspace") {
        openChannelMenu();
      } else if (e.key === "ArrowDown") {
        if (channelList.classList.contains("open")) {
          currentIndex = (currentIndex + 1) % channelItems.length;
          updateVisualSelection();
        }
      } else if (e.key === "ArrowUp") {
        if (channelList.classList.contains("open")) {
          currentIndex =
            (currentIndex - 1 + channelItems.length) % channelItems.length;
          updateVisualSelection();
        }
      } else if (e.key === "ArrowRight") {
        if (channelList.classList.contains("open")) {
          epg.classList.add("open");
          const selectedChannel =
            channelItems[currentIndex].getAttribute("data-channel");
          loadEPG(selectedChannel);
        }
      } else if (e.key === "ArrowLeft") {
        if (epg.classList.contains("open")) {
          epg.classList.remove("open");
        }
      }
    });

    channelItems.forEach((item, index) => {
      item.addEventListener("click", () => {
        currentIndex = index;
        updateVisualSelection();
        updateVideoSource();
      });
    });

    playerContainer.addEventListener("click", openChannelMenu);
    playerContainer.addEventListener("touchend", openChannelMenu);
  });
</script>
